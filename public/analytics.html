<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - LEAN BOT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .analytics-container {
            background: var(--background-dark);
            min-height: 100vh;
            padding: 20px;
        }
        
        .analytics-header {
            background: linear-gradient(135deg, var(--color-spicy-mix), var(--color-accent-orange));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .metric-card {
            background: var(--color-crowshead);
            border: 1px solid var(--color-taupe);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            border-color: var(--color-accent-orange);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--color-accent-orange);
        }
        
        .metric-label {
            color: var(--color-dust-storm);
            font-size: 1.1rem;
            margin-top: 10px;
        }
        
        .chart-container {
            background: var(--color-crowshead);
            border: 1px solid var(--color-taupe);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .sentiment-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        
        /* Paleta de colores UI/UX para sentimientos */
        .sentiment-positive {
            background: #28a745;  /* Verde - Positivo */
            color: white;
        }
        
        .sentiment-negative {
            background: #dc3545;  /* Rojo - Negativo */
            color: white;
        }
        
        .sentiment-neutral {
            background: #6c757d;  /* Azul/Gris - Neutral */
            color: white;
        }
        
        /* Indicador de IA integrada */
        .ai-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(255, 123, 0, 0.15);
            border-radius: 12px;
            font-size: 0.75rem;
            color: var(--color-accent-orange);
            font-weight: 600;
        }
        
        .conversation-item {
            background: var(--color-crowshead);
            border: 1px solid var(--color-taupe);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .keyword-tag {
            background: var(--color-spicy-mix);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin: 2px;
            display: inline-block;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .refresh-btn {
            background: var(--color-accent-orange);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .refresh-btn:hover {
            background: #e55a00;
        }
        
        .model-info {
            background: var(--color-crowshead);
            border: 1px solid var(--color-taupe);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .model-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background: #28a745;
        }
        
        .status-inactive {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="analytics-container">
        <!-- Header -->
        <div class="analytics-header">
            <h1>üìä Analytics Dashboard - LEAN BOT</h1>
            <p>An√°lisis avanzado de sentimientos con BETO (BERT en Espa√±ol)</p>
            <button class="refresh-btn" onclick="refreshDashboard()">üîÑ Actualizar Datos</button>
        </div>

        <!-- Model Information -->
        <div class="model-info">
            <h5>ü§ñ Informaci√≥n del Modelo</h5>
            <div id="modelInfo">
                <div class="loading-spinner">
                    <div class="spinner-border text-warning" role="status"></div>
                </div>
            </div>
        </div>

        <!-- Metrics Overview -->
        <div class="row">
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="totalMessages">-</div>
                    <div class="metric-label">Mensajes Analizados (24h)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="avgConfidence">-</div>
                    <div class="metric-label">Confianza Promedio</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="dominantSentiment">-</div>
                    <div class="metric-label">Sentimiento Dominante</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card text-center">
                    <div class="metric-value" id="activeConversations">-</div>
                    <div class="metric-label">Conversaciones Activas</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>üìà Distribuci√≥n de Sentimientos</h5>
                    <canvas id="sentimentChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>‚è∞ Tendencias por Hora</h5>
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Analytics Row -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>üéØ Distribuci√≥n de Confianza</h5>
                    <canvas id="confidenceChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>üìä Comparativa Semanal vs 24h</h5>
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Keywords and Conversations -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>üî§ Palabras Clave por Sentimiento</h5>
                    <div id="keywordsContainer">
                        <div class="loading-spinner">
                            <div class="spinner-border text-warning" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>üí¨ Conversaciones Activas</h5>
                    <div id="conversationsContainer">
                        <div class="loading-spinner">
                            <div class="spinner-border text-warning" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Details Section -->
        <div class="chart-container">
            <h5>üë§ Detalles de Conversaci√≥n Espec√≠fica</h5>
            <div class="row">
                <div class="col-md-8">
                    <input type="text" id="chatUserId" class="form-control" 
                           placeholder="Ingresa el ID del usuario para ver detalles de su chat..." 
                           style="background: var(--color-crowshead); border: 1px solid var(--color-taupe); color: white;">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-info w-100" onclick="loadChatDetails()">Ver Detalles del Chat</button>
                </div>
            </div>
            <div id="chatDetailsResult" class="mt-3"></div>
        </div>

        <!-- Test Section -->
        <div class="chart-container">
            <h5>üß™ Prueba del Sistema de An√°lisis</h5>
            <div class="row">
                <div class="col-md-8">
                    <input type="text" id="testText" class="form-control" 
                           placeholder="Escribe un texto para analizar su sentimiento..." 
                           style="background: var(--color-crowshead); border: 1px solid var(--color-taupe); color: white;">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-warning w-100" onclick="testSentiment()">Analizar Sentimiento</button>
                </div>
            </div>
            <div id="testResult" class="mt-3"></div>
        </div>
    </div>

    <!-- Scripts de configuraci√≥n -->
    <script src="js/env-config.js"></script>
    
    <script>
        let charts = {};
        
        // Configuraci√≥n base para los gr√°ficos
        Chart.defaults.color = '#e4cfcd';
        Chart.defaults.borderColor = '#413530';
        Chart.defaults.backgroundColor = 'rgba(255, 102, 0, 0.1)';

        async function loadDashboardData() {
            try {
                // Obtener la URL base correcta
                const baseURL = window.ENV_CONFIG ? ENV_CONFIG.getBaseURL() : '';
                
                // Cargar informaci√≥n del modelo
                console.log('üîç Cargando informaci√≥n del modelo...');
                const modelInfoResponse = await fetch(`${baseURL}/sentiment/model-info`);
                if (!modelInfoResponse.ok) {
                    throw new Error(`Error ${modelInfoResponse.status}: ${modelInfoResponse.statusText}`);
                }
                const modelInfo = await modelInfoResponse.json();
                displayModelInfo(modelInfo);

                // Cargar datos del dashboard
                console.log('üìä Cargando datos del dashboard...');
                const dashboardResponse = await fetch(`${baseURL}/analytics/dashboard`);
                if (!dashboardResponse.ok) {
                    throw new Error(`Error ${dashboardResponse.status}: ${dashboardResponse.statusText}`);
                }
                const dashboardData = await dashboardResponse.json();
                
                // Actualizar m√©tricas
                updateMetrics(dashboardData);
                
                // Crear gr√°ficos
                createSentimentChart(dashboardData.metrics_24h);
                createHourlyChart(dashboardData.hourly_trends);
                createConfidenceChart(dashboardData.metrics_24h);
                createComparisonChart(dashboardData.metrics_24h, dashboardData.metrics_week);
                
                // Mostrar palabras clave y conversaciones
                displayKeywords(dashboardData.sentiment_keywords);
                displayActiveConversations(dashboardData.active_conversations);
                
            } catch (error) {
                console.error('‚ùå Error loading dashboard data:', error);
                showError(`Error al cargar los datos del dashboard: ${error.message}`);
                
                // Mostrar informaci√≥n de fallback
                displayFallbackInfo();
            }
        }

        function displayModelInfo(modelInfo) {
            const container = document.getElementById('modelInfo');
            const statusClass = modelInfo.available ? 'status-active' : 'status-inactive';
            const statusText = modelInfo.available ? 'Activo' : 'Inactivo';
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Modelo BETO:</strong> ${modelInfo.model_name}<br>
                        <strong>Estado:</strong> <span class="model-status ${statusClass}"></span>${statusText}
                        <span class="ai-indicator ms-2">‚ú® IA Integrada</span>
                    </div>
                    <div class="col-md-6">
                        <strong>Dispositivo:</strong> ${modelInfo.device}<br>
                        <strong>Precisi√≥n:</strong> >95% promedio
                    </div>
                </div>
            `;
        }

        function updateMetrics(data) {
            const metrics24h = data.metrics_24h || data;
            
            document.getElementById('totalMessages').textContent = metrics24h.total_messages || 0;
            document.getElementById('avgConfidence').textContent = ((metrics24h.average_confidence || 0) * 100).toFixed(1) + '%';
            
            // Sentimiento dominante con icono seg√∫n UI/UX
            const dominantSentiment = metrics24h.dominant_sentiment;
            const sentimentIcons = {
                'POS': 'üòä',
                'NEG': 'üôÅ',
                'NEU': 'üòê',
                'positivo': 'üòä',
                'negativo': 'üôÅ',
                'neutral': 'üòê'
            };
            const icon = sentimentIcons[dominantSentiment] || 'üòê';
            const label = getSentimentLabel(dominantSentiment);
            
            document.getElementById('dominantSentiment').innerHTML = `${icon} ${label}`;
            document.getElementById('activeConversations').textContent = (data.active_conversations || []).length;
        }

        function createSentimentChart(metrics) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            if (charts.sentiment) {
                charts.sentiment.destroy();
            }
            
            // Colores seg√∫n gu√≠a UI/UX: Verde=Positivo, Rojo=Negativo, Azul/Gris=Neutral
            charts.sentiment = new Chart(ctx, {
                type: 'doughnut',  // Gr√°fico de dona seg√∫n especificaci√≥n
                data: {
                    labels: ['Positivo üòä', 'Negativo üôÅ', 'Neutral üòê'],
                    datasets: [{
                        data: [metrics.positive_count, metrics.negative_count, metrics.neutral_count],
                        backgroundColor: [
                            '#28a745',  // Verde - Positivo
                            '#dc3545',  // Rojo - Negativo
                            '#6c757d'   // Azul/Gris - Neutral
                        ],
                        borderWidth: 3,
                        borderColor: '#413530'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 13,
                                    weight: '500'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createHourlyChart(hourlyTrends) {
            const ctx = document.getElementById('hourlyChart').getContext('2d');
            
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            
            const hours = hourlyTrends.map(h => h.hour + ':00');
            const positiveCounts = hourlyTrends.map(h => h.positive_count || 0);
            const negativeCounts = hourlyTrends.map(h => h.negative_count || 0);
            const neutralCounts = hourlyTrends.map(h => h.neutral_count || 0);
            
            // Gr√°fico de l√≠nea temporal interactivo seg√∫n UI/UX
            charts.hourly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: 'Positivo üòä',
                            data: positiveCounts,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Negativo üôÅ',
                            data: negativeCounts,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Neutral üòê',
                            data: neutralCounts,
                            borderColor: '#6c757d',
                            backgroundColor: 'rgba(108, 117, 125, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            displayColors: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
        }

        function createConfidenceChart(metrics) {
            const ctx = document.getElementById('confidenceChart').getContext('2d');
            
            if (charts.confidence) {
                charts.confidence.destroy();
            }
            
            const distribution = metrics.confidence_distribution;
            
            charts.confidence = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Baja (<60%)', 'Media (60-80%)', 'Alta (>80%)'],
                    datasets: [{
                        label: 'Cantidad de Mensajes',
                        data: [distribution.low, distribution.medium, distribution.high],
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745'],
                        borderWidth: 1,
                        borderColor: '#413530'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function createComparisonChart(metrics24h, metricsWeek) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (charts.comparison) {
                charts.comparison.destroy();
            }
            
            charts.comparison = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Positivo', 'Negativo', 'Neutral'],
                    datasets: [{
                        label: '√öltimas 24h',
                        data: [metrics24h.positive_count, metrics24h.negative_count, metrics24h.neutral_count],
                        backgroundColor: 'rgba(255, 102, 0, 0.7)'
                    }, {
                        label: '√öltima Semana',
                        data: [metricsWeek.positive_count, metricsWeek.negative_count, metricsWeek.neutral_count],
                        backgroundColor: 'rgba(125, 78, 63, 0.7)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function displayKeywords(keywords) {
            const container = document.getElementById('keywordsContainer');
            
            let html = '';
            
            // Mostrar palabras negativas primero (en Rojo) seg√∫n UI/UX
            if (keywords.NEG && keywords.NEG.length > 0) {
                html += `
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <span class="sentiment-badge sentiment-negative">üôÅ Palabras Negativas</span>
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            ${keywords.NEG.slice(0, 10).map(word => 
                                `<span class="badge" style="background: #dc3545; padding: 6px 12px; font-size: 0.85rem;">${word}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Mostrar palabras positivas (en Verde) seg√∫n UI/UX
            if (keywords.POS && keywords.POS.length > 0) {
                html += `
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <span class="sentiment-badge sentiment-positive">üòä Palabras Positivas</span>
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            ${keywords.POS.slice(0, 10).map(word => 
                                `<span class="badge" style="background: #28a745; padding: 6px 12px; font-size: 0.85rem;">${word}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Mostrar palabras neutrales (en Azul/Gris)
            if (keywords.NEU && keywords.NEU.length > 0) {
                html += `
                    <div class="mb-3">
                        <h6 class="mb-2">
                            <span class="sentiment-badge sentiment-neutral">üòê Palabras Neutrales</span>
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            ${keywords.NEU.slice(0, 10).map(word => 
                                `<span class="badge" style="background: #6c757d; padding: 6px 12px; font-size: 0.85rem;">${word}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<p class="text-muted">No hay palabras clave disponibles</p>';
        }

        function displayActiveConversations(conversations) {
            const container = document.getElementById('conversationsContainer');
            
            if (conversations.length === 0) {
                container.innerHTML = '<p class="text-muted">No hay conversaciones activas</p>';
                return;
            }
            
            let html = '';
            conversations.slice(0, 5).forEach(conv => {
                const timeAgo = getTimeAgo(conv.last_activity);
                html += `
                    <div class="conversation-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Usuario:</strong> ${conv.user_id}<br>
                                <small class="text-muted">Mensajes: ${conv.message_count}</small>
                            </div>
                            <div class="text-end">
                                <span class="sentiment-badge sentiment-${getSentimentClass(conv.dominant_sentiment)}">
                                    ${getSentimentLabel(conv.dominant_sentiment)}
                                </span><br>
                                <small class="text-muted">${timeAgo}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function testSentiment() {
            const text = document.getElementById('testText').value.trim();
            const resultContainer = document.getElementById('testResult');
            
            if (!text) {
                resultContainer.innerHTML = '<div class="alert alert-warning">Por favor, ingresa un texto para analizar</div>';
                return;
            }
            
            try {
                resultContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-warning" role="status"></div></div>';
                
                const response = await fetch('/sentiment/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        user_id: 'test_user',
                        conversation_id: 'test_conversation'
                    })
                });
                
                const result = await response.json();
                
                resultContainer.innerHTML = `
                    <div class="alert alert-info">
                        <h6>Resultado del An√°lisis:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Sentimiento:</strong><br>
                                <span class="sentiment-badge sentiment-${getSentimentClass(result.sentiment)}">
                                    ${result.label}
                                </span>
                            </div>
                            <div class="col-md-4">
                                <strong>Confianza:</strong><br>
                                ${(result.confidence * 100).toFixed(1)}%
                            </div>
                            <div class="col-md-4">
                                <strong>Modelo:</strong><br>
                                ${result.analysis_type || 'BETO'}
                            </div>
                        </div>
                        <div class="mt-2">
                            <strong>Scores detallados:</strong><br>
                            <small>
                                POS: ${(result.scores.POS * 100).toFixed(1)}% | 
                                NEG: ${(result.scores.NEG * 100).toFixed(1)}% | 
                                NEU: ${(result.scores.NEU * 100).toFixed(1)}%
                            </small>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error testing sentiment:', error);
                resultContainer.innerHTML = '<div class="alert alert-danger">Error al analizar el sentimiento</div>';
            }
        }

        function getSentimentLabel(sentiment) {
            const labels = {
                'POS': 'Positivo',
                'NEG': 'Negativo', 
                'NEU': 'Neutral',
                'positivo': 'Positivo',
                'negativo': 'Negativo',
                'neutral': 'Neutral'
            };
            return labels[sentiment] || sentiment;
        }

        function getSentimentClass(sentiment) {
            const classes = {
                'POS': 'positive',
                'NEG': 'negative',
                'NEU': 'neutral',
                'positivo': 'positive',
                'negativo': 'negative',
                'neutral': 'neutral'
            };
            return classes[sentiment] || 'neutral';
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diffMs = now - time;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Ahora';
            if (diffMins < 60) return `${diffMins}m`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h`;
            return `${Math.floor(diffMins / 1440)}d`;
        }

        function displayFallbackInfo() {
            // Mostrar informaci√≥n b√°sica cuando la API no est√° disponible
            const modelContainer = document.getElementById('modelInfo');
            if (modelContainer) {
                modelContainer.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è API no disponible</strong><br>
                        Conectando con el backend...
                    </div>
                `;
            }
            
            // Mostrar m√©tricas de ejemplo
            updateMetrics({
                total_messages: 0,
                avg_confidence: 0,
                positive_ratio: 0,
                negative_ratio: 0,
                neutral_ratio: 0
            });
        }

        function showError(message) {
            const container = document.querySelector('.analytics-container');
            container.innerHTML = `
                <div class="alert alert-danger text-center">
                    <h4>‚ùå Error de Conexi√≥n</h4>
                    <p>${message}</p>
                    <p><small>Verifica que el backend est√© funcionando correctamente.</small></p>
                    <button class="btn btn-warning" onclick="location.reload()">üîÑ Reintentar</button>
                    <a href="/chat" class="btn btn-secondary ms-2">‚Üê Volver al Chat</a>
                </div>
            `;
        }

        async function loadChatDetails() {
            const userId = document.getElementById('chatUserId').value.trim();
            const resultContainer = document.getElementById('chatDetailsResult');
            
            if (!userId) {
                resultContainer.innerHTML = '<div class="alert alert-warning">Por favor ingresa un ID de usuario</div>';
                return;
            }
            
            resultContainer.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-info" role="status"></div></div>';
            
            try {
                // Obtener datos del usuario y chat
                const response = await fetch(`/analytics/chat-details/${userId}`);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                const chatData = await response.json();
                
                if (!chatData.found) {
                    resultContainer.innerHTML = '<div class="alert alert-warning">No se encontr√≥ ning√∫n chat para este usuario</div>';
                    return;
                }
                
                // Mostrar detalles del chat
                displayChatDetails(chatData);
                
            } catch (error) {
                console.error('Error loading chat details:', error);
                resultContainer.innerHTML = '<div class="alert alert-danger">Error al cargar los detalles del chat</div>';
            }
        }
        
        function displayChatDetails(chatData) {
            const container = document.getElementById('chatDetailsResult');
            const { user_info, chat_stats, messages, sentiment_analysis } = chatData;
            
            let html = `
                <div class="alert alert-success">
                    <h6>üìä Detalles del Chat - Usuario: ${user_info.doc_id}</h6>
                    
                    <!-- Estad√≠sticas generales -->
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-value">${chat_stats.total_messages}</div>
                                <div class="metric-label">Total Mensajes</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-value">${(sentiment_analysis.avg_confidence * 100).toFixed(1)}%</div>
                                <div class="metric-label">Confianza Promedio</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-value sentiment-${getSentimentClass(sentiment_analysis.dominant_sentiment)}">${getSentimentLabel(sentiment_analysis.dominant_sentiment)}</div>
                                <div class="metric-label">Sentimiento Dominante</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center">
                                <div class="metric-value">${chat_stats.score || 'N/A'}</div>
                                <div class="metric-label">Score General</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Distribuci√≥n de sentimientos -->
                    <div class="mt-3">
                        <h6>üìà Distribuci√≥n de Sentimientos:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <span class="sentiment-badge sentiment-positive">Positivos: ${sentiment_analysis.sentiment_counts.positive}</span>
                            </div>
                            <div class="col-md-4">
                                <span class="sentiment-badge sentiment-negative">Negativos: ${sentiment_analysis.sentiment_counts.negative}</span>
                            </div>
                            <div class="col-md-4">
                                <span class="sentiment-badge sentiment-neutral">Neutrales: ${sentiment_analysis.sentiment_counts.neutral}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historial de mensajes -->
                    <div class="mt-4">
                        <h6>üí¨ Historial de Conversaci√≥n:</h6>
                        <div class="chat-history" style="max-height: 400px; overflow-y: auto; background: var(--color-crowshead); padding: 15px; border-radius: 8px;">
            `;
            
            // Agregar mensajes
            messages.forEach((msg, index) => {
                const sentimentClass = getSentimentClass(msg.sentiment);
                const confidence = msg.confidence ? (msg.confidence * 100).toFixed(1) : 'N/A';
                
                html += `
                    <div class="message-item mb-3 p-3" style="background: var(--color-taupe); border-radius: 8px; border-left: 4px solid var(--color-${sentimentClass === 'positive' ? 'spicy-mix' : sentimentClass === 'negative' ? 'accent-orange' : 'taupe'});">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <strong>üë§ Usuario:</strong> ${msg.message}<br>
                                ${msg.response ? `<strong>ü§ñ Bot:</strong> ${msg.response}<br>` : ''}
                                <small class="text-muted">
                                    üìÖ ${new Date(msg.timestamp).toLocaleString('es-ES')} | 
                                    <span class="sentiment-badge sentiment-${sentimentClass}">${getSentimentLabel(msg.sentiment)}</span> 
                                    (${confidence}% confianza)
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function refreshDashboard() {
            // Mostrar indicador de carga
            document.querySelectorAll('.metric-value').forEach(el => el.textContent = '-');
            
            // Recargar datos
            loadDashboardData();
        }

        // Permitir an√°lisis con Enter
        document.getElementById('testText').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testSentiment();
            }
        });

        // Permitir cargar detalles del chat con Enter
        document.getElementById('chatUserId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadChatDetails();
            }
        });

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', loadDashboardData);
        
        // Auto-refresh cada 5 minutos
        setInterval(loadDashboardData, 300000);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEAN - Chat</title>
    <link rel="icon" type="image/png" href="img/Favicon.png">
    <link href="css/styles.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="chat-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <img src="img/LOGO LEAN.png" alt="LEAN Logo" />
                    </div>
                    <span class="logo-text">LEAN</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="chat" class="nav-item active">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span>Chat Principal</span>
                </a>
                
                <a href="dashboard" class="nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17V9"/>
                        <path d="M13 17V5"/>
                        <path d="M8 17v-3"/>
                    </svg>
                    <span>Mi Dashboard</span>
                </a>
                
                <a href="#" class="nav-item" id="settings-nav">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="m12 1 2.09 1.26a12 12 0 0 1 0 21.48L12 23l-2.09-1.26a12 12 0 0 1 0-21.48L12 1"/>
                    </svg>
                    <span>Configuración</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info" id="user-info">
                    <div class="user-avatar">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="user-details">
                        <span class="user-name" id="user-name">Usuario</span>
                        <button class="logout-btn" onclick="LoginManager.logout()">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-status">
                    <div class="status-indicator">
                        <div class="status-dot pulsing"></div>
                        <span>Chat Activo</span>
                    </div>
                </div>
                <button class="analysis-btn" onclick="window.location.href='dashboard'">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 3v18h18"/>
                        <path d="M18 17V9"/>
                        <path d="M13 17V5"/>
                        <path d="M8 17v-3"/>
                    </svg>
                    Mi Dashboard
                </button>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messages-container">
                <!-- Welcome message will be added by JavaScript -->
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="chat-input" 
                        placeholder="Escribe tu mensaje..." 
                        autocomplete="off"
                    />
                    <button id="send-btn" class="send-button">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"/>
                            <polygon points="22,2 15,22 11,13 2,9"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Configuración del Chatbot</h3>
            
            <div class="form-group">
                <label for="api-key-input">Clave API de Gemini:</label>
                <div class="password-container">
                    <input type="password" id="api-key-input" placeholder="Ingresa tu clave API aquí...">
                    <button type="button" id="toggle-password" title="Mostrar/Ocultar clave">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>
                <small class="form-text">La clave API se guardará solo en este dispositivo.</small>
            </div>
            
            <div class="form-group">
                <label for="gemini-model-select">Modelo de Gemini:</label>
                <select id="gemini-model-select">
                    <option value="gemini-1.5-flash-latest">gemini-1.5-flash (rápido)</option>
                    <option value="gemini-1.5-pro-latest">gemini-1.5-pro (preciso)</option>
                </select>
            </div>
            
            <div class="form-actions">
                <button id="save-api-settings" class="btn-primary">Guardar</button>
                <button id="test-api-connection" class="btn-secondary">Probar conexión</button>
            </div>
            
            <div id="api-test-result"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/env-config.js"></script>
    <script src="js/login.js"></script>
    <script src="js/config.js"></script>
    <script src="js/leanbot-api.js"></script>
    <script src="js/voiceRecognition.js"></script>
    <script src="js/chatbot.js"></script>
    
    <!-- Enhanced Chat Script -->
    <script>
        class ChatInterface {
            constructor() {
                this.messagesContainer = document.getElementById('messages-container');
                this.chatMessages = document.getElementById('messages-container'); // Alias para compatibilidad
                this.chatInput = document.getElementById('chat-input');
                this.sendBtn = document.getElementById('send-btn');
                this.questions = [];
                this.numberedQuestions = null; // Para almacenar las preguntas numeradas
                this.welcomeOptionsShown = false;
                this.sessionData = null;
                this.chatHistory = [];
                
                this.init();
            }

            async init() {
                // Check session
                const session = LoginManager.checkSession();
                if (!session) {
                    window.location.href = './login';
                    return;
                }
                
                this.sessionData = session;
                
                // Update user info
                this.updateUserInfo(session);
                
                // Load chat context from API
                await this.loadChatContext();
                
                // Load questions and show welcome
                await this.loadQuestions();
                this.showWelcomeMessage();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Setup settings modal
                this.setupSettingsModal();
            }

            updateUserInfo(session) {
                const userName = document.getElementById('user-name');
                if (userName) {
                    // Mostrar documento con información adicional si está disponible
                    const displayText = session.doc_id ? 
                        `Doc: ${session.doc_id}` : 
                        `Usuario: ${session.documento}`;
                    userName.textContent = displayText;
                }
                
                // Log de información de sesión para debugging
                console.log('Datos de sesión completos:', {
                    documento: session.documento,
                    doc_id: session.doc_id,
                    chat_id: session.chat_id,
                    userId: session.userId
                });
            }

            async loadChatContext() {
                if (!this.sessionData.doc_id) {
                    console.warn('No se encontró doc_id en la sesión');
                    return;
                }

                try {
                    console.log(`Cargando contexto del chat para usuario: ${this.sessionData.doc_id}`);
                    
                    const response = await fetch(`https://hackaton-d1h6.onrender.com/usuarios/${this.sessionData.doc_id}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`Error al cargar contexto: ${response.status}`);
                    }

                    const userData = await response.json();
                    console.log('Contexto del chat cargado:', userData);

                    // Actualizar datos de sesión si hay información nueva
                    if (userData.chat) {
                        this.sessionData.chat_id = userData.chat.id;
                        
                        // Si hay mensajes previos, cargarlos y mostrarlos
                        if (userData.chat.mensajes) {
                            try {
                                let mensajes = [];
                                
                                // Intentar parsear como JSON (formato nuevo)
                                if (typeof userData.chat.mensajes === 'string') {
                                    mensajes = JSON.parse(userData.chat.mensajes);
                                } else if (Array.isArray(userData.chat.mensajes)) {
                                    mensajes = userData.chat.mensajes;
                                }
                                
                                // Mostrar mensajes en la interfaz
                                if (mensajes.length > 0) {
                                    console.log('📋 Cargando historial de chat:', mensajes.length, 'mensajes');
                                    
                                    // Limpiar chat actual
                                    this.messagesContainer.innerHTML = '';
                                    this.chatHistory = [];
                                    
                                    // Mostrar cada mensaje del historial
                                    mensajes.forEach(messageData => {
                                        // Mensaje del usuario
                                        if (messageData.message) {
                                            this.addUserMessage(messageData.message);
                                            this.chatHistory.push({
                                                role: 'user',
                                                content: messageData.message,
                                                timestamp: messageData.timestamp || new Date().toISOString()
                                            });
                                        }
                                        
                                        // Respuesta del bot
                                        if (messageData.response) {
                                            this.addBotMessage(messageData.response);
                                            this.chatHistory.push({
                                                role: 'assistant',
                                                content: messageData.response,
                                                timestamp: messageData.timestamp || new Date().toISOString()
                                            });
                                        }
                                    });
                                    
                                    // Desplazarse al final del chat
                                    this.scrollToBottom();
                                    console.log('✅ Historial cargado y mostrado');
                                } else {
                                    console.log('📋 No hay historial previo');
                                    this.chatHistory = [];
                                }
                            } catch (error) {
                                console.error('Error al parsear mensajes:', error);
                                this.chatHistory = [];
                            }
                        } else {
                            console.log('📋 No hay mensajes previos');
                            this.chatHistory = [];
                        }

                        // Actualizar localStorage con la información más reciente
                        const currentSession = JSON.parse(localStorage.getItem('lean_session'));
                        currentSession.chat_id = userData.chat.id;
                        currentSession.chatData = userData.chat;
                        localStorage.setItem('lean_session', JSON.stringify(currentSession));
                    }

                } catch (error) {
                    console.error('Error al cargar contexto del chat:', error);
                    // Continuar sin el contexto si hay error
                }
            }

            async loadQuestions() {
                try {
                    const response = await fetch('data/data.json');
                    const data = await response.json();
                    this.questions = data.faq.filter(item => 
                        item.question && 
                        item.answer && 
                        !item.question.includes('Felicitaciones') &&
                        !item.question.includes('comentarios')
                    );
                } catch (error) {
                    console.error('Error loading questions:', error);
                    this.questions = [
                        { question: "¿Qué servicios ofrece LEAN?", answer: "Servicios de ingeniería y automatización" },
                        { question: "¿Cómo puedo contactarlos?", answer: "Información de contacto disponible" },
                        { question: "¿Qué es la automatización industrial?", answer: "Explicación sobre automatización" }
                    ];
                }
            }

            getRandomQuestions(count = 3) {
                const shuffled = [...this.questions].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }

            showWelcomeMessage() {
                // Verificar si hay mensajes existentes en el historial
                if (this.chatHistory && this.chatHistory.length > 0) {
                    console.log('Cargando mensajes existentes del historial');
                    this.loadExistingMessages();
                    return;
                }
                
                // Si no hay mensajes existentes, mostrar mensaje de bienvenida
                const welcomeHTML = `
                    <div class="message bot-message" data-timestamp="${new Date().toLocaleTimeString()}">
                        <div class="message-avatar bot-avatar">
                            <img src="img/Favicon.png" alt="Bot" width="40" height="40" />
                        </div>
                        <div class="message-content">
                            <div class="message-text">
                                ¡Hola! Soy LEAN, tu asistente virtual. ¿En qué puedo ayudarte con eso? ¿Podrías proporcionar más detalles?
                            </div>
                            <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
                
                this.messagesContainer.innerHTML = welcomeHTML;
                
                // Show welcome options after a brief delay
                setTimeout(() => {
                    this.showWelcomeOptions();
                }, 500);
            }

            loadExistingMessages() {
                // Limpiar contenedor de mensajes
                this.messagesContainer.innerHTML = '';
                
                // Cargar cada mensaje del historial
                this.chatHistory.forEach(message => {
                    if (message.role === 'user') {
                        this.addUserMessage(message.content, false); // false = no enviar al servidor
                    } else if (message.role === 'assistant') {
                        this.addBotMessage(message.content, false); // false = no agregar al historial
                    }
                });
                
                // Si no hay mensajes o solo hay mensajes de sistema, mostrar opciones
                const userMessages = this.chatHistory.filter(msg => msg.role === 'user');
                if (userMessages.length === 0) {
                    setTimeout(() => {
                        this.showWelcomeOptions();
                    }, 500);
                }
            }

            showWelcomeOptions() {
                if (this.welcomeOptionsShown) return;
                
                const randomQuestions = this.getRandomQuestions(3);
                const emojis = ['🤔', '💡', '❓'];
                
                const optionsHTML = `
                    <div class="welcome-options" id="welcome-options">
                        <p class="options-text">Selecciona una opción para comenzar o escribe un número (1-3):</p>
                        <div class="option-buttons">
                            ${randomQuestions.map((q, index) => `
                                <button class="option-btn" data-question="${q.question}" data-number="${index + 1}">
                                    ${index + 1}. ${emojis[index]} ${q.question.replace(/^\d+\.\s*/, '')}
                                </button>
                            `).join('')}
                        </div>
                        <p class="options-hint">💡 También puedes escribir 1, 2 o 3 para seleccionar una opción</p>
                    </div>
                `;
                
                this.messagesContainer.insertAdjacentHTML('beforeend', optionsHTML);
                this.scrollToBottom();
                this.welcomeOptionsShown = true;
                
                // Guardar las preguntas numeradas para referencia
                this.numberedQuestions = randomQuestions;
                
                // Add click handlers to option buttons
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const question = e.target.dataset.question;
                        this.handleOptionClick(question);
                    });
                });
            }

            async handleOptionClick(question) {
                // Remove welcome options
                const welcomeOptions = document.getElementById('welcome-options');
                if (welcomeOptions) {
                    welcomeOptions.remove();
                }
                
                // Send question as user message
                this.addUserMessage(question.replace(/^\d+\.\s*/, ''));
                
                // Agregar al historial
                this.chatHistory.push({
                    role: 'user',
                    content: question.replace(/^\d+\.\s*/, ''),
                    timestamp: new Date().toISOString()
                });
                
                // Get bot response
                try {
                    const selectedQuestion = this.questions.find(q => q.question === question);
                    const answer = selectedQuestion ? selectedQuestion.answer : "Gracias por tu pregunta. Te ayudo con eso.";
                    
                    // Simular delay
                    setTimeout(() => {
                        this.addBotMessage(answer);
                    }, 1000);
                } catch (error) {
                    console.error('Error al manejar la opción:', error);
                    this.addBotMessage("Gracias por tu pregunta. Te ayudo con eso.");
                }
            }

            setupEventListeners() {
                // Send button click
                this.sendBtn.addEventListener('click', () => {
                    this.sendMessage();
                });
                
                // Enter key press
                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
                
                // Settings button
                const settingsNav = document.getElementById('settings-nav');
                if (settingsNav) {
                    settingsNav.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.getElementById('settings-modal').style.display = 'block';
                    });
                }
            }

            sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message) return;
                
                // Verificar si es un número y hay opciones disponibles
                if (this.numberedQuestions && /^[1-3]$/.test(message)) {
                    const questionIndex = parseInt(message) - 1;
                    if (questionIndex >= 0 && questionIndex < this.numberedQuestions.length) {
                        const selectedQuestion = this.numberedQuestions[questionIndex];
                        
                        // Remover opciones de bienvenida
                        const welcomeOptions = document.getElementById('welcome-options');
                        if (welcomeOptions) {
                            welcomeOptions.remove();
                        }
                        
                        // Enviar la pregunta seleccionada
                        this.addUserMessage(selectedQuestion.question.replace(/^\d+\.\s*/, ''));
                        this.chatInput.value = '';
                        
                        // Simular respuesta del bot
                        setTimeout(() => {
                            this.addBotMessage(selectedQuestion.answer);
                        }, 1000);
                        
                        return;
                    }
                }
                
                this.addUserMessage(message);
                this.chatInput.value = '';
                
                // Agregar mensaje al historial
                this.chatHistory.push({
                    role: 'user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                // Enviar a la API
                this.sendMessageToAPI(message);
            }

            async sendMessageToAPI(userMessage) {
                if (!this.sessionData.chat_id) {
                    console.error('No se encontró chat_id');
                    this.addBotMessage('Error: No se pudo conectar con el chat.');
                    return;
                }

                try {
                    // Mostrar indicador de escritura
                    this.showTypingIndicator();

                    let botResponse;
                    
                    // Usar LEAN BOT API en lugar del sistema legacy
                    if (window.leanBotAPI && window.leanBotAPI.isBackendAvailable) {
                        try {
                            console.log('🤖 Usando LEAN BOT para procesar mensaje...');
                            const leanBotResponse = await window.leanBotAPI.sendMessage(userMessage);
                            
                            if (leanBotResponse && leanBotResponse.response) {
                                botResponse = leanBotResponse.response;
                                console.log('✅ Respuesta de LEAN BOT obtenida');
                            } else {
                                throw new Error('No se obtuvo respuesta de LEAN BOT');
                            }
                        } catch (error) {
                            console.error('❌ Error con LEAN BOT, usando fallback:', error);
                            // Fallback a respuesta local si está disponible getBotResponse
                            if (typeof getBotResponse === 'function') {
                                botResponse = await getBotResponse(userMessage);
                            } else {
                                botResponse = await this.generateSmartResponse(userMessage);
                            }
                        }
                    } else {
                        console.log('🔄 LEAN BOT no disponible, usando respuesta local');
                        // Fallback a respuesta local
                        if (typeof getBotResponse === 'function') {
                            botResponse = await getBotResponse(userMessage);
                        } else {
                            botResponse = await this.generateSmartResponse(userMessage);
                        }
                    }

                    // Remover indicador de escritura
                    this.hideTypingIndicator();

                    // Mostrar respuesta del bot
                    this.addBotMessage(botResponse);
                    
                    // Agregar respuesta del bot al historial
                    this.chatHistory.push({
                        role: 'assistant',
                        content: botResponse,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Actualizar chat con la respuesta del bot si el backend está disponible
                    try {
                        const finalChatUpdate = {
                            mensajes: this.chatHistory, // Enviar como array, no como string JSON
                            score: null
                        };

                        await fetch(`https://hackaton-d1h6.onrender.com/chats/${this.sessionData.chat_id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(finalChatUpdate)
                        });
                    } catch (updateError) {
                        console.warn('No se pudo actualizar el chat en el backend:', updateError);
                    }

                } catch (error) {
                    console.error('Error al enviar mensaje:', error);
                    this.hideTypingIndicator();
                    
                    // Si hay error, intentar respuesta local del chatbot
                    try {
                        const fallbackResponse = await getBotResponse(userMessage);
                        this.addBotMessage(fallbackResponse);
                    } catch (fallbackError) {
                        this.addBotMessage('Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta nuevamente.');
                    }
                }
            }

            addUserMessage(text, shouldAddToHistory = true) {
                const messageHTML = `
                    <div class="message user-message" data-timestamp="${new Date().toLocaleTimeString()}">
                        <div class="message-content">
                            <div class="message-text">${text}</div>
                            <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                        <div class="message-avatar user-avatar">
                            <div class="avatar-text">U</div>
                        </div>
                    </div>
                `;
                
                this.messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                this.scrollToBottom();
            }

            addBotMessage(text, shouldAddToHistory = true) {
                const messageHTML = `
                    <div class="message bot-message" data-timestamp="${new Date().toLocaleTimeString()}">
                        <div class="message-avatar bot-avatar">
                            <img src="img/Favicon.png" alt="Bot" width="40" height="40" />
                        </div>
                        <div class="message-content">
                            <div class="message-text">${text}</div>
                            <div class="message-time">${new Date().toLocaleTimeString()}</div>
                        </div>
                    </div>
                `;
                
                this.messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                this.scrollToBottom();
                
                // Agregar al historial solo si se especifica
                if (shouldAddToHistory) {
                    this.chatHistory.push({
                        role: 'assistant',
                        content: text,
                        timestamp: new Date().toISOString()
                    });
                }
            }

            simulateBotResponse(userMessage) {
                const responses = [
                    "Entiendo tu consulta. Permíteme ayudarte con eso. ¿Podrías proporcionar más detalles?",
                    "Gracias por tu pregunta. Te ayudo con información sobre nuestros servicios.",
                    "Excelente pregunta. En LEAN nos especializamos en soluciones de ingeniería y automatización.",
                    "Te puedo ayudar con eso. ¿Hay algo específico que te gustaría saber?",
                    "Perfecto. Déjame darte información detallada sobre ese tema."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                this.addBotMessage(randomResponse);
            }

            showTypingIndicator() {
                const typingMessage = document.createElement('div');
                typingMessage.className = 'message bot-message typing-indicator';
                typingMessage.id = 'typing-indicator';
                typingMessage.innerHTML = `
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                this.chatMessages.appendChild(typingMessage);
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            generateBotResponse(userMessage) {
                const responses = [
                    "Entiendo tu consulta. ¿Podrías darme más detalles sobre lo que necesitas?",
                    "Esa es una excelente pregunta. Basándome en mi análisis, te sugiero...",
                    "He procesado tu mensaje. Aquí tienes algunas opciones que podrían ayudarte:",
                    "Gracias por tu consulta. Según mi experiencia, la mejor opción sería...",
                    "Interesante punto. Déjame analizar esto y darte una respuesta más detallada..."
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }

            setupSettingsModal() {
                const modal = document.getElementById('settings-modal');
                const closeBtn = modal.querySelector('.close');
                
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
                
                window.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
        }

        // Initialize chat when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ChatInterface();
        });
    </script>
</body>
</html>
